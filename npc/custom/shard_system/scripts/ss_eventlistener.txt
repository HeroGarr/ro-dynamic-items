/**
 * When a shard is equipped, find the equip slot, turn on
 * the EQI_ACC_SLOT_SS flag where SLOT is L or R.
 *
 * When a monster is killed my a PC, invoke SSEventListener
 * to distribute experience. Invoke SSEventHandler to manage
 * calculations.
 */
- script SSEventListener -1,{
    // Function definitions.
    function distributeExperience;
    function updateFlags;
    function isEquipped;
    
    // Events
    // ======
    OnPCLoginEvent:
        if(isEquipped) {
            @BaseExp = BaseExp;
            @NextBaseExp = NextBaseExp;
            @BaseLevel = BaseLevel;
        }
    end;

    OnPCEquipEvent:
        updateFlags;
        @BaseExp = BaseExp;
        @NextBaseExp = NextBaseExp;
        @BaseLevel = BaseLevel;
    end;
    
    OnPCUnequipEvent:
        updateFlags;
    end;

    OnPCBaseLvUpEvent:
        if(isEquipped) {
            @GainedExp = BaseExp + (@NextBaseExp - @BaseExp);
            @BaseLevel = BaseLevel;
            distributeExperience;
        }
    end;
    
    OnNPCKillEvent:
        if(isEquipped && (@BaseLevel == BaseLevel)) {
            @GainedExp = BaseExp - @BasedExp;
            @BaseExp = BaseExp;
            distributeExperience;
        }
    end;

    // Functions
    // =========
    function    distributeExperience {
        if(EQI_ACC_L_FLAG && EQI_ACC_R_FLAG) {
            callfunc("SSEventHandler", EQI_ACC_L, @GainedExp);
            callfunc("SSEventHandler", EQI_ACC_R, @GainedExp);
        }
        
        if(EQI_ACC_L_FLAG || EQI_ACC_R_FLAG) {
            if(EQI_ACC_L_FLAG)
                callfunc("SSEventHandler", EQI_ACC_L, @GainedExp);
            else
                callfunc("SSEventHandler", EQI_ACC_R, @GainedExp);
        }
    }
    
    function    updateFlags {
        EQI_ACC_L_SS = (getiteminfo(getequipid(EQI_ACC_L), 2) == 20 ? true : false);
        EQI_ACC_R_SS = (getiteminfo(getequipid(EQI_ACC_R), 2) == 20 ? true : false);
    }

    function    isEquipped {
        return EQI_ACC_L_SS || EQI_ACC_R_SS;
    }
}
