/**
 * Provides experience to the shard then
 * upgrades it when level threshold is met.
 * @param .@shard_id The shard receiving experience.
 * @param .@equip_slot Equipment slot for clarification.
 */
function script SSEventHandler {
    // Local function declarations.
    function updateExperience;
    function getMobExperience;
    function getNextExperience;
    function upgradeShard;
    function getPrimaryKey;
    function getShardLevel;

    // Data definitions
    .@shard_id = getarg(0);
    .@equip_slot = getarg(1);
    .@shard_key = getPrimaryKey;
    .@shard_level = getShardLevel;

    // MAIN CALL
    updateExperience;
    return;


    // MAIN FUNCTIONS
    // ========================================================================
    /**
     * This function will store experience points, known as "quintessence", for
     * leveling up shards. Calls getExperience to calculate essence. A shard becomes
     * a crystal when its max level is attained.
     */
    function updateExperience {
        // Store mob exp into the experience field.
        query_sql("
            UPDATE `shard`
            SET `experience` = `experience` + "+ getMobExperience +"
            WHERE `id` = " + .@shard_key
        ");

        // Provide the player with the next level shard if level threshold is met.
        if(query_sql("SELECT `experience` FROM `shard` WHERE `id` = " + .@shard_key) >= getNextExperience)
            upgradeShard;

        // Success
        return 0;
    }

    /**
     * Upgrade the shard and provide player with the next
     * level of the item.
     * TODO: Make a script to ensure the right shard
     *       is equipped.
     */
    function upgradeShard {
        // Unequip and delete the old shard.
        unequip .@equip_slot;
        SSDeleteShard(.@shard_id, .@shard_key);

        // Create and equip the new shard.
        SSUpgradeShard(.@shard_id, .@shard_key);
        SSEquipShard(.@shard_id + 1, .@shard_key);
        return;
    }

    /**
     * Returns the 32-bit primary key.
     */
    function getPrimaryKey {
        return (getequipcardid(.@equip_slot, 2) << 16) + getequipcardid(.@equip_slot, 3);
    }

    /**
     * Returns the Shard level.
     */
    function getShardLevel {
        return getiteminfo(.@shard_id, 13);
    }
    
    /**
     * Returns the last slain mob's experience.
     * TODO: Ensure -1 is never returned?
     * TODO: Should shard_exp_rate increase based on difficulty_factor?
     * TODO: Recreate this to use BaseExp, NextBaseExp and the difference
     * between monster kills. This will be more accurate.
     */
    function getMobExperience {
        // Make sure shard_exp_rate is not negative or zero.
        if(($shard_exp_rate - (.@shard_level * 2) <= 0)
            $shard_exp_rate = 1;

        // Gather a percentage of monster base experience by shard_exp_rate.
        .@gained_exp = ($shard_exp_rate - (.@shard_level * 2)) * (getmonsterinfo(killedrid, MOB_BASEEXP) / 100);

        // Provide a bonus based on shard_exp_boss_rate when a mini-boss or boss is killed.
        if(getmonsterinfo(killedrid, MOB_MODE) & 32)
            .@gained_exp += $shard_exp_boss_rate * (.@gained_exp / 100);

        return .@gained_exp;
    }

    /**
     * Returns the experience necessary to level.
     */
    function getNextExperience    {
        // Make sure difficulty_ratio is not negative or zero.
        if($difficulty_ratio <= 0)
            $difficulty_ratio = 1;

        // Calculate the base experience 
        .@base_next_level = $shard_base_exp * $server_rate;

        // ...
    }
}
